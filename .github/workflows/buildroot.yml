name: Build Linux using BuildRoot

on:
  workflow_dispatch:
    inputs:
      defconfig:
        description: "BuildRoot defconfig file"
        required: true
        default: "generic_x86_64_defconfig"
        type: choice
        options:
          - generic_x86_64_defconfig
          - raspberrypi4_64_defconfig
      test_image:
        description: "Test built image with QEMU"
        required: false
        default: true
        type: boolean
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
    types: [opened, synchronize, reopened]

env:
  BUILDROOT_VERSION: "2024.02.1"

jobs:
  validate:
    name: Validate configurations
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate configuration files
        run: |
          # Check for required directories
          if [[ ! -d "buildroot-configs" ]]; then
            echo "âŒ buildroot-configs directory not found"
            exit 1
          fi

          # Validate defconfig files
          find buildroot-configs -name "*_defconfig" -type f | while read config; do
            echo "ðŸ” Validating $config"
            if ! grep -q "BR2_HAVE_DOT_CONFIG=y" "$config" 2>/dev/null; then
              echo "âš ï¸  Warning: $config may not be a valid BuildRoot defconfig"
            fi
          done

          # Check for kernel configs
          find buildroot-configs -name "linux.config" -type f | while read config; do
            echo "ðŸ” Validating kernel config $config"
            if ! grep -q "CONFIG_" "$config" 2>/dev/null; then
              echo "âš ï¸  Warning: $config may not be a valid Linux kernel config"
            fi
          done

      - name: Set build matrix
        id: set-matrix
        run: |
          # Find all defconfig files
          configs=$(find buildroot-configs -name "*_defconfig" -type f -exec basename {} \; | tr '\n' ' ')
          echo "Found configs: $configs"
          
          # Create JSON matrix
          matrix=$(echo "$configs" | jq -R 'split(" ") | map(select(length > 0)) | map({defconfig: .}) | {include: .}')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  build:
    name: Build ${{ matrix.defconfig }}
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.validate.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "MY_BUILDROOT_CONFIG=${{ matrix.defconfig }}" >> $GITHUB_ENV
          echo "LINUX_NAME=${{ matrix.defconfig }}%_defconfig" >> $GITHUB_ENV
          echo "ARCH=$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)" >> $GITHUB_ENV

      - name: Cache BuildRoot source
        uses: actions/cache@v4
        with:
          path: buildroot-${{ env.BUILDROOT_VERSION }}
          key: ${{ runner.os }}-buildroot-source-${{ env.BUILDROOT_VERSION }}-${{ hashFiles('**/buildroot-configs/**') }}
          restore-keys: |
            ${{ runner.os }}-buildroot-source-${{ env.BUILDROOT_VERSION }}-

      - name: Cache BuildRoot build
        uses: actions/cache@v4
        with:
          path: buildroot-${{ env.BUILDROOT_VERSION }}/output
          key: ${{ runner.os }}-buildroot-build-${{ matrix.defconfig }}-${{ env.BUILDROOT_VERSION }}-${{ hashFiles('buildroot-configs/**/${{ matrix.defconfig }}') }}
          restore-keys: |
            ${{ runner.os }}-buildroot-build-${{ matrix.defconfig }}-${{ env.BUILDROOT_VERSION }}-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential libncurses5-dev libssl-dev libpcap-dev \
            net-tools git rsync unzip wget curl bc python3 python3-pip \
            qemu-system-x86 qemu-system-arm qemu-utils \
            cpio kmod udev device-tree-compiler swig \
            libncursesw5-dev bison flex libelf-dev libssl-dev \
            jq nc telnet

      - name: Download BuildRoot
        if: steps.cache-buildroot.outputs.cache-hit != 'true'
        run: |
          if [[ ! -d "buildroot-${{ env.BUILDROOT_VERSION }}" ]]; then
            wget https://buildroot.org/downloads/buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
            tar -xzf buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
            rm buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
          fi

      - name: Prepare BuildRoot
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          
          # Copy our configuration
          if [[ -f "../buildroot-configs/${{ matrix.defconfig }}" ]]; then
            cp "../buildroot-configs/${{ matrix.defconfig}}" "configs/${{ matrix.defconfig }}"
          else
            echo "âŒ Configuration file not found: ${{ matrix.defconfig }}"
            exit 1
          fi

          # Copy kernel config if exists
          kernel_config_path="../buildroot-configs/board/$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)/linux.config"
          if [[ -f "$kernel_config_path" ]]; then
            mkdir -p board/$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)
            cp "$kernel_config_path" "board/$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)/linux.config"
          fi

          # Copy post build script if exists
          post_build_script="../buildroot-configs/board/post_build.sh"
          if [[ -f "$post_build_script" ]]; then
            cp "$post_build_script" "board/post_build.sh"
            chmod +x "board/post_build.sh"
          fi

          # Copy device table if exists
          device_table="../buildroot-configs/system/device_table.txt"
          if [[ -f "$device_table" ]]; then
            cp "$device_table" "system/device_table.txt"
          fi

      - name: Configure BuildRoot
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          make "${{ matrix.defconfig }}"

      - name: Build BuildRoot
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          
          # Set parallel jobs
          JOBS=$(nproc)
          echo "Building with $JOBS parallel jobs"
          
          # Build with timeout
          timeout 4h make -j${JOBS} || {
            echo "âŒ Build failed or timed out"
            echo "=== Build log tail ==="
            tail -n 100 build.log || true
            exit 1
          }

      - name: Create build report
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          
          echo "=== Build Report ===" > build-report.txt
          echo "BuildRoot Version: ${{ env.BUILDROOT_VERSION }}" >> build-report.txt
          echo "Configuration: ${{ matrix.defconfig }}" >> build-report.txt
          echo "Architecture: ${{ env.ARCH }}" >> build-report.txt
          echo "Build Date: $(date)" >> build-report.txt
          echo "" >> build-report.txt
          echo "=== Output Files ===" >> build-report.txt
          ls -la output/images/ >> build-report.txt || true
          echo "" >> build-report.txt
          echo "=== File Sizes ===" >> build-report.txt
          du -sh output/images/* >> build-report.txt || true
          echo "" >> build-report.txt
          echo "=== Build Statistics ===" >> build-report.txt
          find output/build -name "*.so" | wc -l | xargs echo "Shared libraries:" >> build-report.txt || true
          find output/build -name "*.a" | wc -l | xargs echo "Static libraries:" >> build-report.txt || true
          
          cat build-report.txt

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report-${{ matrix.defconfig }}
          path: buildroot-${{ env.BUILDROOT_VERSION }}/build-report.txt
          retention-days: 30

      - name: Upload test results
        if: matrix.defconfig == 'generic_x86_64_defconfig' && github.event.inputs.test_image != 'false'
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.defconfig }}
          path: |
            buildroot-${{ env.BUILDROOT_VERSION }}/test-results.json
            buildroot-${{ env.BUILDROOT_VERSION }}/qemu-*.log
          retention-days: 30

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.defconfig }}-artifacts
          path: buildroot-${{ env.BUILDROOT_VERSION }}/output/images/
          retention-days: 7

      - name: Test with QEMU (x86_64)
        if: matrix.defconfig == 'generic_x86_64_defconfig' && github.event.inputs.test_image != 'false'
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          
          if [[ -f "output/images/bzImage" && -f "output/images/rootfs.ext2" ]]; then
            echo "ðŸ§ª Testing image with QEMU..."
            
            # Run comprehensive QEMU tests
            ../test-ci.sh --arch x86_64 --suite basic --timeout 300 output
            
            echo "âœ… QEMU test completed"
          else
            echo "âš ï¸  QEMU test skipped - missing required files"
          fi

  security-scan:
    name: Security scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: 'buildroot-configs'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  summary:
    name: Build summary
    runs-on: ubuntu-latest
    needs: [validate, build]
    if: always()
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-report-*
          merge-multiple: false

      - name: Create summary
        run: |
          echo "# ðŸš€ BuildRoot Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“Š Build Results" >> $GITHUB_STEP_SUMMARY
          
          for report_dir in build-report-*; do
            if [[ -d "$report_dir" ]]; then
              config=$(echo "$report_dir" | sed 's/build-report-//')
              echo "### $config" >> $GITHUB_STEP_SUMMARY
              if [[ -f "$report_dir/build-report.txt" ]]; then
                echo '```' >> $GITHUB_STEP_SUMMARY
                cat "$report_dir/build-report.txt" >> $GITHUB_STEP_SUMMARY
                echo '```' >> $GITHUB_STEP_SUMMARY
              fi
              echo "" >> $GITHUB_STEP_SUMMARY
            fi
          done

      - name: Comment PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            
            // Read build reports
            let summary = "## ðŸš€ BuildRoot Build Results\\n\\n";
            let allSuccessful = true;
            
            try {
              const files = fs.readdirSync('.').filter(f => f.startsWith('build-report-'));
              
              for (const file of files) {
                if (fs.statSync(file).isDirectory()) {
                  const config = file.replace('build-report-', '');
                  const reportPath = `${file}/build-report.txt`;
                  
                  if (fs.existsSync(reportPath)) {
                    const report = fs.readFileSync(reportPath, 'utf8');
                    summary += `### ${config}\\n\\n`;
                    summary += '```\\n' + report + '\\n```\\n\\n';
                  }
                }
              }
            } catch (error) {
              console.log('Error reading reports:', error);
            }
            
            // Create or update comment
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: summary
            });
