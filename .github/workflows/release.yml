name: Release BuildRoot Linux OS

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        default: "v1.0.0"
      prerelease:
        description: "Mark as pre-release"
        required: false
        default: false
        type: boolean
      create_release:
        description: "Create GitHub release"
        required: false
        default: true
        type: boolean

env:
  BUILDROOT_VERSION: "2024.02.1"

jobs:
  validate:
    name: Validate release configuration
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      version: ${{ steps.set-version.outputs.version }}
      is_prerelease: ${{ steps.set-version.outputs.is_prerelease }}
      create_release: ${{ steps.set-version.outputs.create_release }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set release version
        id: set-version
        run: |
          if [[ "${{ github.event_name }}" == "push" && "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
            IS_PRERELEASE=false
            CREATE_RELEASE=true
          else
            VERSION="${{ github.event.inputs.version }}"
            IS_PRERELEASE="${{ github.event.inputs.prerelease }}"
            CREATE_RELEASE="${{ github.event.inputs.create_release }}"
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "is_prerelease=$IS_PRERELEASE" >> $GITHUB_OUTPUT
          echo "create_release=$CREATE_RELEASE" >> $GITHUB_OUTPUT

      - name: Validate configuration files
        run: |
          echo "Validating release configuration..."
          if [[ ! -d "buildroot-configs" ]]; then
            echo "buildroot-configs directory not found"
            exit 1
          fi
          configs=$(find buildroot-configs -name "*_defconfig" -type f)
          if [[ -z "$configs" ]]; then
            echo "No defconfig files found"
            exit 1
          fi
          echo "Found $(echo "$configs" | wc -l) configuration files"

      - name: Set build matrix
        id: set-matrix
        run: |
          configs=$(find buildroot-configs -name "*_defconfig" -type f -exec basename {} \; | tr '\n' ' ')
          echo "Found configs: $configs"
          matrix=$(echo "$configs" | jq -R 'split(" ") | map(select(length > 0)) | map({defconfig: .}) | {include: .}')
          echo "matrix=$matrix" >> $GITHUB_OUTPUT

  build-release:
    name: Build ${{ matrix.defconfig }}
    needs: validate
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.validate.outputs.matrix) }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set variables
        run: |
          echo "MY_BUILDROOT_CONFIG=${{ matrix.defconfig }}" >> $GITHUB_ENV
          echo "LINUX_NAME=${{ matrix.defconfig%_defconfig }}" >> $GITHUB_ENV
          echo "ARCH=$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)" >> $GITHUB_ENV
          echo "VERSION=${{ needs.validate.outputs.version }}" >> $GITHUB_ENV

      - name: Cache BuildRoot source
        uses: actions/cache@v4
        with:
          path: buildroot-${{ env.BUILDROOT_VERSION }}
          key: ${{ runner.os }}-buildroot-source-${{ env.BUILDROOT_VERSION }}-${{ hashFiles('**/buildroot-configs/**') }}

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential libncurses5-dev libssl-dev libpcap-dev net-tools git rsync unzip wget curl bc python3 python3-pip qemu-system-x86 qemu-system-arm qemu-utils cpio kmod udev device-tree-compiler swig libncursesw5-dev bison flex libelf-dev libssl-dev zip p7zip-full jq nc telnet

      - name: Download BuildRoot
        run: |
          if [[ ! -d "buildroot-${{ env.BUILDROOT_VERSION }}" ]]; then
            wget https://buildroot.org/downloads/buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
            tar -xzf buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
            rm buildroot-${{ env.BUILDROOT_VERSION }}.tar.gz
          fi

      - name: Prepare BuildRoot
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          
          if [[ -f "../buildroot-configs/${{ matrix.defconfig }}" ]]; then
            cp "../buildroot-configs/${{ matrix.defconfig}}" "configs/${{ matrix.defconfig }}"
          else
            echo "Configuration file not found: ${{ matrix.defconfig }}"
            exit 1
          fi

          kernel_config_path="../buildroot-configs/board/$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)/linux.config"
          if [[ -f "$kernel_config_path" ]]; then
            mkdir -p board/$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)
            cp "$kernel_config_path" "board/$(echo '${{ matrix.defconfig }}' | cut -d'_' -f1)/linux.config"
          fi

          post_build_script="../buildroot-configs/board/post_build.sh"
          if [[ -f "$post_build_script" ]]; then
            cp "$post_build_script" "board/post_build.sh"
            chmod +x "board/post_build.sh"
          fi

          device_table="../buildroot-configs/system/device_table.txt"
          if [[ -f "$device_table" ]]; then
            cp "$device_table" "system/device_table.txt"
          fi

      - name: Configure BuildRoot
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          make "${{ matrix.defconfig }}"

      - name: Build BuildRoot
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          JOBS=$(nproc)
          echo "Building with $JOBS parallel jobs"
          timeout 6h make -j${JOBS} || {
            echo "Build failed or timed out"
            tail -n 100 build.log || true
            exit 1
          }

      - name: Create release package
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          mkdir -p "release-${{ matrix.defconfig }}-${{ env.VERSION }}"
          cp -r output/images/* "release-${{ matrix.defconfig }}-${{ env.VERSION }}/" 2>/dev/null || true
          
          echo "BuildRoot Linux OS Release" > "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"
          echo "==========================" >> "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"
          echo "" >> "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"
          echo "Version: ${{ env.VERSION }}" >> "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"
          echo "Configuration: ${{ matrix.defconfig }}" >> "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"
          echo "Architecture: ${{ env.ARCH }}" >> "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"
          echo "Build Date: $(date)" >> "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"
          echo "BuildRoot Version: ${{ env.BUILDROOT_VERSION }}" >> "release-${{ matrix.defconfig }}-${{ env.VERSION }}/README.txt"

      - name: Create checksums
        run: |
          cd "release-${{ matrix.defconfig }}-${{ env.VERSION }}"
          sha256sum * > sha256sums.txt
          md5sum * > md5sums.txt
          echo "Checksums created"

      - name: Create archive
        run: |
          tar -czf "${{ matrix.defconfig }}-${{ env.VERSION }}.tar.gz" "release-${{ matrix.defconfig }}-${{ env.VERSION }}/"
          zip -r "${{ matrix.defconfig }}-${{ env.VERSION }}.zip" "release-${{ matrix.defconfig }}-${{ env.VERSION }}/"
          echo "Archives created"

      - name: Test with QEMU (x86_64)
        if: matrix.defconfig == 'generic_x86_64_defconfig'
        run: |
          cd buildroot-${{ env.BUILDROOT_VERSION }}
          
          if [[ -f "output/images/bzImage" && -f "output/images/rootfs.ext2" ]]; then
            echo "Testing release image with QEMU..."
            
            # Run comprehensive QEMU tests
            ../test-ci.sh --arch x86_64 --suite basic --timeout 300 output
            
            echo "QEMU test completed"
          else
            echo "QEMU test skipped - missing required files"
          fi

      - name: Upload build artifacts
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.defconfig }}-${{ env.VERSION }}-artifacts
          path: |
            buildroot-${{ env.BUILDROOT_VERSION }}/output/images/
            ${{ matrix.defconfig }}-${{ env.VERSION }}.tar.gz
            ${{ matrix.defconfig }}-${{ env.VERSION }}.zip
          retention-days: 30

      - name: Upload build report
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.defconfig }}-${{ env.VERSION }}-report
          path: |
            buildroot-${{ env.BUILDROOT_VERSION }}/build.log
            buildroot-${{ env.BUILDROOT_VERSION }}/output/build/build-time.log
          retention-days: 30

      - name: Upload test results
        if: matrix.defconfig == 'generic_x86_64_defconfig'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.defconfig }}-${{ env.VERSION }}-test-results
          path: |
            buildroot-${{ env.BUILDROOT_VERSION }}/test-results.json
            buildroot-${{ env.BUILDROOT_VERSION }}/qemu-*.log
          retention-days: 30

  create-release:
    name: Create GitHub Release
    needs: [validate, build-release]
    runs-on: ubuntu-latest
    if: needs.validate.outputs.create_release == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v7
        with:
          pattern: "*-${{ needs.validate.outputs.version }}.tar.gz"
          merge-multiple: false

      - name: Create release notes
        run: |
          cat > release_notes.md << 'EOF'
# BuildRoot Linux OS RELEASE_VERSION

## Release Information

- Version: RELEASE_VERSION
- BuildRoot Version: BUILDROOT_VERSION
- Release Date: DATE
- Type: Release

## Available Configurations

This release includes all supported configurations:
- generic_x86_64_defconfig (QEMU and x86_64 hardware)
- raspberrypi4_64_defconfig (Raspberry Pi 4)
- arm64_dev_defconfig (Generic ARM64 development)

## Installation

### Quick Start

1. Download the desired configuration archive
2. Extract the archive
3. Follow the instructions in the README.txt file

### QEMU Testing

For x86_64 configurations:
bash
qemu-system-x86_64 -m 512M -kernel bzImage -hda rootfs.ext2 -append root=/dev/sda console=ttyS0

For ARM64 configurations:
bash
qemu-system-aarch64 -m 512M -kernel Image -hda rootfs.ext2 -append root=/dev/sda console=ttyAMA0

### Raspberry Pi 4

1. Extract raspberrypi4_64_defconfig archive
2. Copy all files to SD card boot partition
3. Insert SD card and boot the Raspberry Pi

## Verification

Each release includes:
- SHA256 checksums (sha256sums.txt)
- MD5 checksums (md5sums.txt)

Verify your download:
bash
sha256sum -c sha256sums.txt

## Bug Reports

Please report issues at the repository issues page.

## Documentation

Full documentation is available in the repository README.

Note: This release was automatically built and tested using GitHub Actions.
EOF
          
          sed -i "s/RELEASE_VERSION/${{ needs.validate.outputs.version }}/g" release_notes.md
          sed -i "s/BUILDROOT_VERSION/${{ env.BUILDROOT_VERSION }}/g" release_notes.md
          sed -i "s/DATE/$(date)/g" release_notes.md

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          name: BuildRoot Linux OS ${{ needs.validate.outputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease }}
          files: "*.tar.gz"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    name: Security scan
    runs-on: ubuntu-latest
    needs: build-release
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: "fs"
          scan-ref: "buildroot-configs"
          format: "sarif"
          output: "trivy-results.sarif"

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: "trivy-results.sarif"

  release-summary:
    name: Release Summary
    runs-on: ubuntu-latest
    needs: [validate, build-release, create-release]
    if: always()
    
    steps:
      - name: Create release summary
        run: |
          echo "BuildRoot Linux OS Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Release Information:" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${{ needs.validate.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- Type: ${{ needs.validate.outputs.is_prerelease == 'true' && 'Pre-release' || 'Stable' }}" >> $GITHUB_STEP_SUMMARY
          echo "- BuildRoot Version: ${{ env.BUILDROOT_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Release Created: ${{ needs.create-release.result == 'success' && 'Yes' || 'No' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Build Results:" >> $GITHUB_STEP_SUMMARY
          echo "All configurations built successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- Configuration archives (.tar.gz, .zip)" >> $GITHUB_STEP_SUMMARY
          echo "- Build reports and logs" >> $GITHUB_STEP_SUMMARY
          echo "- Test results and logs" >> $GITHUB_STEP_SUMMARY
          echo "- Checksum files for verification" >> $GITHUB_STEP_SUMMARY

      - name: Notify on success
        if: needs.create-release.result == 'success'
        run: |
          echo "Release ${{ needs.validate.outputs.version }} created successfully!"
          echo "All artifacts uploaded and ready for download"

      - name: Notify on failure
        if: failure()
        run: |
          echo "Release process failed"
          echo "Check workflow logs for details"